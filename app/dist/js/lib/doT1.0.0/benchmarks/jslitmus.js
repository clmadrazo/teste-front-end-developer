// Copyright (c) 2010, Robert Kieffer, http://broofa.com

// Available under MIT license (http://en.wikipedia.org/wiki/MIT_License)

(function(){function i(e){typeof console!="undefined"?console.log(e):n&&util.log(e)}function s(e){return e}function o(e,t){for(var n in t)e[n]=t[n];return e}function u(e,t){for(var n=0,r=e&&e.length;n<r;n++){var i=e[n];t(i,n)}}function a(e,t){var n,r=[];for(var i=0,s=e&&e.length;i<s;i++){var n=e[i];r.push(t(n,i))}return r}function f(e,t){var n,r=[];for(var i=0,s=e&&e.length;i<s;i++){var n=e[i];t(n,i)&&r.push(n)}return r}function l(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}function c(e){return e=e.replace(/,/g,"\\,"),e=r?r.escape(e):escape(e),e=e.replace(/\+/g,"%2b"),e=e.replace(/ /g,"+"),e}function h(e,t,n){var r=!t&&!n;r&&(t="&",n="=");var i=[];for(var s in e){var o=e[s];r&&(o=c(o)),i.push(s+n+e[s])}return i.join(t)}function p(e,t,n){var r=!t&&!n;r&&(e=e.replace(/.*[?#]/,""),t="&",n="=");if(match){var i=query.split(t);for(var s=0;s<i.length;s++){var o=i[s].split(new RegExp(n+"+")),u=o.shift(),a=r&&o.length>1?o.join(n):o[0];i[u]=a}}return i}function d(e,t){var n=Math.ceil(Math.log(Math.abs(e))/Math.log(10)),r=Math.pow(10,n-t);return Math.round(e/r)*r}function v(e,t){var n=Math.abs(e),r;return t|=4,n==Infinity?r=n>0?"Infinity":"-Infinity":n>1e9?r=d(e/1e9,t)+"G":n>1e6?r=d(e/1e6,t)+"M":n>1e3?r=d(e/1e3,t)+"k":n>.01?r=d(e,t):n>.001?r=d(e/.001,t)+"m":n>1e-6?r=d(e/1e-6,t)+"Âµ":n>1e-9?r=d(e/1e-9,t)+"n":r=e?d(e,t):0,r=(r+"").replace(/0{5,}\d*/,""),r}function m(){var e=this,t={};o(e,{on:function(e,n){t[e]||(t[e]=[]),t[e].push(n)},removeListener:function(e,n){t[e]=f(t[e],function(e){return e!=n})},removeAllListeners:function(e){t[e]=[]},emit:function(n){var r=Array.prototype.slice.call(arguments,1);u([].concat(t[n],t["*"]),function(t){e._emitting=n,t&&t.apply(e,r)}),delete e._emitting}})}function g(e,t){function s(){return delete n.count,delete n.time,delete n.running,n.emit("reset",n),n}function u(){var n=o(new g(e,t),n);return n.reset()}function a(e){var t=null;while(e--){var r=u();r.run(null,!0);if(!t||r.period<t.period)t=r}o(n,t)}function f(e,t){return e=e||n.INIT_COUNT,n.running=!0,t?l(e,t):setTimeout(function(){l(e)},1),n}function l(e,t){try{var s,o=n.f,u,a=e;s=new Date,n.count=e,n.time=0,n.period=0,n.emit("start",n);if(r)o(e);else while(a--)o();n.time=Math.max(1,new Date-s)/1e3,n.count=e,n.period=n.time/e,n.running=n.time<n.MIN_TIME,n.emit("results",n);if(n.running){var c=n.MIN_TIME/n.time,h=Math.pow(2,Math.max(1,Math.ceil(Math.log(c)/Math.log(2))));e*=h;if(e>n.MAX_COUNT)throw new Error("Max count exceeded.  If this test uses a looping function, make sure the iteration loop is working properly.");t?l(e,t):f(e)}else n.emit("complete",n)}catch(p){i(p),n.emit("error",p)}return n}function c(e){var t=n.period;if(e){var r=n.isLoop?g.LOOP_CAL:g.NOLOOP_CAL;r.period||(r.MIN_TIME=.3,r.bestOf(3)),t=Math.max(0,t-r.period)}return d(1/t,4)}var n=this;m.call(n);if(!t)throw new Error("Undefined test function");if(!/function[^\(]*\(([^,\)]*)/.test(t))throw new Error('"'+e+'" test: Invalid test function');var r=!!RegExp.$1;o(n,{name:e,f:t,isLoop:r,clone:u,run:f,bestOf:a,getHz:c,reset:s}),n.toString=function(){return this.time?this.name+", f = "+v(this.getHz())+"hz ("+v(this.count)+"/"+v(this.time)+"secs)":this.name+", count = "+v(this.count)}}function S(e,t){var n=new g(e,t);return b.push(n),n.on("*",function(){var e=Array.prototype.slice.call(arguments);e.unshift(n._emitting),y.emit.apply(y,e),n._emitting=="complete"&&(E=null,N())}),y.emit("added",n),n}function x(e){u(b,C)}function T(){while(w.length)var e=w.shift()}function N(){if(!E){var e=w.shift();e?(E=e,e.run()):y.emit("all_complete")}}function C(e){if(l(w,e)>=0)return;w.push(e),N()}function k(){b=[]}function L(e){var n=["Operations/second on "+t.name,"("+t.version+" / "+t.os+")"],r=b.length,i=[],s=[],o,u=0,f=-1e10,i=a(b,function(e,t){if(e.count){var n=e.getHz(),r=n!=Infinity?n:0;s.push(r);var i=e.name+"("+v(n)+")",o="t"+c(i)+",000000,0,"+t+",10";return f=Math.max(r,f),o}});if(i.length<=0)return null;var l=[v(u),v(f)],p=250,d=15,m=5,g=i.length*(d+m)+30+n.length*20,y={chtt:escape(n.join("|")),chts:"000000,10",cht:"bhg",chd:"t:"+s.join(","),chds:u+","+f,chxt:"x",chxl:"0:|"+l.join("|"),chsp:"0,1",chm:i.join("|"),chbh:[d,0,m].join(","),chs:p+"x"+g},w="http://chart.apis.google.com/chart?"+h(y);return w}var e=this,t=function(){var t={name:null,version:null,os:null,description:"unknown platform",toString:function(){return this.description}};if(e.navigator){var n=navigator.userAgent,r="Windows|iPhone OS|(?:Intel |PPC )?Mac OS X|Linux";t.os=(new RegExp("(("+r+") +[^ );]*)")).test(n)?RegExp.$1.replace(/_/g,"."):null,t.name=/(Chrome|MSIE|Safari|Opera|Firefox|Minefield)/.test(n)?RegExp.$1:null;if(t.name=="Opera")t.version=opera.name;else if(t.name){var i=new RegExp("(Version|"+t.name+")[ /]([^ ;]*)");t.version=i.test(n)?RegExp.$2:null}}else e.process&&process.platform&&(t.name="node",t.version=process.version,t.os=process.platform);var s=[];return t.name&&s.push(t.name),t.version&&s.push(" "+t.version),t.os&&s.push(" on "+t.os),s.length&&(t.description=s.join("")),t}(),n=null,r=null;t.name=="node"&&(util=require("util"),r=require("querystring")),o(g,{LOOP_CAL:new g("loop cal",function(e){while(e--);}),NOLOOP_CAL:new g("noloop cal",s)}),o(g.prototype,{INIT_COUNT:10,MAX_COUNT:1e9,MIN_TIME:1});var y;t.name=="node"?y=exports:y=e.jslitmus={};var b=[],w=[],E;m.call(y),o(y,{Test:g,platform:t,test:S,runAll:x,getGoogleChart:L,clearAll:k}),y.unsupported={nilf:s,log:i,extend:o,forEach:u,filter:f,map:a,indexOf:l,escape2:c,join:h,split:p,sig:d,humanize:v}})();