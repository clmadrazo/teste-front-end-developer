module.exports=function(e){function s(e){var t=[],n=[];return e.split("\n").forEach(function(e){e.trim().slice(0,3)==="//!"?t.push(e.trim()):n.push(e)}),t.concat([""],n).join("\n")}function u(t){return t in o||(o[t]=e.file.read(t)),o[t]}function a(n){var r=n.headerFile?"not_used":n.umdName,i=n.headerFile?u(n.headerFile):"",o=n.skipLines?n.skipLines:0;return t.bundle({base:n.base,entry:n.entry,skip:n.skip||[]}).then(function(t){var u=t.toUmd({name:r}),a=i+u.code.split("\n").slice(o).join("\n");n.moveComments&&(a=s(a)),e.file.write(n.target,a)})}function f(t){var i=50,s=r.resolve(null),o=e.file.expand({cwd:t.base},t.pattern),u,f=function(e){s=s.then(function(){return r.all(o.slice(e,e+i).map(function(e){return a({base:t.base,entry:e,headerFile:t.headerFile,skip:t.skip,skipLines:t.skipLines,moveComments:t.moveComments,target:n.join(t.targetDir,e)})}))})};for(u=0;u<o.length;u+=i)f(u);return s}function l(t){var r=e.file.expand({cwd:t},"**/*.js"),s=i;if(e.file.exists(s))return;r.forEach(function(r){e.file.copy(n.join(t,r),n.join(s,r))})}function c(t){var r=t.entry||n.basename(t.target);return l(t.base),e.file.write(n.join(i,r),t.code),a({base:i,entry:r,umdName:t.umdName||"not_used",headerFile:t.headerFile,skipLines:t.skipLines,moveComments:t.moveComments,target:t.target,skip:t.skip})}function h(e,t){var r=t,i=r.map(function(e){var t=n.basename(e,".js").replace("-","_");return"import "+t+' from "./'+e+'";'}).join("\n");return c({base:"src",code:i,target:e,skip:["moment"],headerFile:"templates/locale-header.js",skipLines:5})}function p(t,r){var i=r,s=i.map(function(e){var t=n.basename(e,".js").replace("-","_"),r=e.replace(".js","");return"import "+t+' from "./'+r+'";'}).join("\n"),o='import * as moment_export from "./moment";\n\n'+s+"\n\n"+"export default moment_export;";return c({base:"src",code:o,umdName:"moment",target:t}).then(function(){var n=e.file.read(t),r=new RegExp("var ([a-z$_]+) =\\s+{[^]\\s+get default \\(\\) { return ([a-z$_]+); }[^]\\s+}",""),i=n.match(r);if(i.length!==3)throw e.file.write("/tmp/crap.js",n),new Error("Failed to detect get default crap, check /tmp/crap.js");n=n.replace(r,"");var s=["moment_with_locales","moment_with_locales_custom"];s.forEach(function(e){var t=e+".locale('en');";n=n.replace("var "+e+" = "+i[1]+";","var "+e+" = "+i[2]+";\n"+"    "+t)});if(n.match("get default"))throw e.file.write("/tmp/crap.js",n),new Error("Stupid shit es6 get default plaguing the code, check /tmp/crap.js");e.file.write(t,n)})}var t=require("esperanto"),n=require("path"),r=require("es6-promise").Promise,i="build/tmp",o={};e.task.registerTask("transpile-raw","convert es6 to umd",function(){var t=this.async();a({base:"src",entry:"moment.js",umdName:"moment",target:"build/umd/moment.js",moveComments:!0}).then(function(){e.log.ok("build/umd/moment.js")}).then(function(){return f({base:"src",pattern:"locale/*.js",headerFile:"templates/locale-header.js",skipLines:5,moveComments:!0,targetDir:"build/umd",skip:["moment"]})}).then(function(){e.log.ok("build/umd/locale/*.js")}).then(function(){return f({base:"src",pattern:"test/moment/*.js",headerFile:"templates/test-header.js",skipLines:5,moveComments:!0,targetDir:"build/umd",skip:["moment"]})}).then(function(){e.log.ok("build/umd/test/moment/*.js")}).then(function(){return f({base:"src",pattern:"test/locale/*.js",headerFile:"templates/test-header.js",skipLines:5,moveComments:!0,targetDir:"build/umd",skip:["moment"]})}).then(function(){e.log.ok("build/umd/test/locale/*.js")}).then(function(){return h("build/umd/min/locales.js",e.file.expand({cwd:"src"},"locale/*.js"))}).then(function(){e.log.ok("build/umd/min/locales.js")}).then(function(){return p("build/umd/min/moment-with-locales.js",e.file.expand({cwd:"src"},"locale/*.js"))}).then(function(){e.log.ok("build/umd/min/moment-with-locales.js")}).then(t,function(n){e.log.error("error transpiling",n),t(n)})}),e.task.registerTask("transpile-custom-raw","build just custom language bundles",function(t){var n=this.async(),r=t.split(",").map(function(t){var r=e.file.expand({cwd:"src"},"locale/"+t+".js");if(r.length===1)return r[0];n(new Error("could not find locale: "+t)),n=null});if(n==null)return;return h("build/umd/min/locales.custom.js",r).then(function(){e.log.ok("build/umd/min/locales.custom.js")}).then(function(){return p("build/umd/min/moment-with-locales.custom.js",r)}).then(function(){e.log.ok("build/umd/min/moment-with-locales.custom.js")}).then(n,function(t){e.log.error("error transpiling-custom",t),n(t)})}),e.config("clean.build",["build"]),e.config("concat.tests",{src:"build/umd/test/**/*.js",dest:"build/umd/min/tests.js"}),e.task.registerTask("transpile","builds all es5 files, optinally creating custom locales",function(t){var n=["clean:build","transpile-raw","concat:tests"];t&&n.push("transpile-custom-raw:"+t),e.task.run(n)})};