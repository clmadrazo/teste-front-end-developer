define(["views/baseView","doT","text!templatesFolder/task/task.html","text!templatesFolder/task/insumo.html","jquery.price_format","jquery-mask","jquery-cpfcnpj","jquery.validate"],function(e,t,n,r){var i=e.extend({el:"#main-wrapper",template:t.template(n),insumoTemplate:t.template(r),taskId:null,dataTask:new Object,qteInsumos:2,valorTotal:0,events:{"click .add-insumo":"_addInsumo","change .cep":"_validateCEP","change #tel_solicitante":"_validateTel","click #endereco_igual":"_checkMesmoEndereco","change .cpf":"_validateCPF","click .btn-submit":"_SubmitForm","change .price":"_valorTotalPedido","change .quantidade":"_valorTotalPedido","click .busca-pedido":"_buscaPedido"},_valorTotalPedido:function(e){var t=$("#valor_material").val()!=""?$("#valor_material").val():0,n=$("#qtde_material").val()!=""?$("#qtde_material").val():0,r=t*n,i=0;for(var s=1;s<=this.qteInsumos;s++){var o=$("#valor_insumo_"+s).val()!=""?$("#valor_insumo_"+s).val():0,u=$("#qtde_insumo_"+s).val()!=""?$("#qtde_insumo_"+s).val():0;i+=o*u}var a=r+i;a!=0&&$(".total-dinheiro").text(this.roundToTwo(a))},roundToTwo:function(e){return+(Math.round(e+"e+2")+"e-2")},_SubmitForm:function(e){e.preventDefault(),this.dataTask.material=$("select#material").val()!=null?$("select#material").val():"",this.dataTask.marca=$("#marca").val(),this.dataTask.data_compra=$("#data_compra").val(),this.dataTask.qtde_material=$("#qtde_material").val(),this.dataTask.valor_pedido=$("#valor_material").val(),this.dataTask.nome_solicitante=$("#nome_solicitante").val(),this.dataTask.cpf_solicitante=$("#cpf_solicitante").val(),this.dataTask.tel_solicitante=$("#tel_solicitante").val(),this.dataTask.cep_solicitante=$("#cep_solicitante").val(),this.dataTask.end_solicitante=$("#end_solicitante").val(),this.dataTask.no_end_solicitante=$("#no_end_solicitante").val(),this.dataTask.comp_solicitante=$("#comp_solicitante").val(),this.dataTask.bairro_solicitante=$("#bairro_solicitante").val(),this.dataTask.cidade_solicitante=$("#cidade_solicitante").val(),this.dataTask.estado_solicitante=$("#estado_solicitante").val(),this.dataTask.cep_entrega=$("#cep_entrega").val(),this.dataTask.end_entrega=$("#end_entrega").val(),this.dataTask.no_end_entrega=$("#no_end_entrega").val(),this.dataTask.bairro_entrega=$("#bairro_entrega").val(),this.dataTask.comp_entrega=$("#comp_entrega").val(),this.dataTask.cidade_entrega=$("#cidade_entrega").val(),this.dataTask.estado_entrega=$("#estado_entrega").val(),$("#endereco_igual").is(":checked")&&(this.dataTask.cep_entrega=this.dataTask.cep_solicitante,this.dataTask.end_entrega=this.dataTask.end_solicitante,this.dataTask.no_end_entrega=this.dataTask.no_end_solicitante,this.dataTask.bairro_entrega=this.dataTask.bairro_solicitante,this.dataTask.comp_entrega=this.dataTask.comp_solicitante,this.dataTask.cidade_entrega=this.dataTask.cidade_solicitante,this.dataTask.estado_entrega=this.dataTask.estado_solicitante),this.dataTask.insumos=new Array;for(var t=1;t<=this.qteInsumos;t++)this.dataTask.insumos[t-1]=new Object,this.dataTask.insumos[t-1].descricao=$("#desc_insumo_"+t).val(),this.dataTask.insumos[t-1].quantidade=$("#qtde_insumo_"+t).val(),this.dataTask.insumos[t-1].preco=$("#valor_insumo_"+t).val();if($(e.currentTarget).hasClass("disabled"))$(".item-task").each(function(){$(this).prop("required")&&($(this).val()==""||$(this).val()==null)&&$(this).css("border-color","red")}),new PNotify({title:"Error",text:"Prencha todos os campos marcados",type:"error",hide:!0,buttons:{closer:!0,sticker:!0},icon:"fa fa-check"});else{var n=localstorage.get("contadorPedidos");n==undefined&&(localstorage.set("contadorPedidos",5),n=localstorage.get("contadorPedidos")),localstorage.set("contadorPedidos",n+1),this.dataTask.idPedido=localstorage.get("contadorPedidos"),this.model.addPedido(this.dataTask)}},_validateCPF:function(e){var t=/^[0-9]{3}\.?[0-9]{3}\.?[0-9]{3}\-?[0-9]{2}$/;if($(e.currentTarget).val()===""||!t.test($(e.currentTarget).val()))return new PNotify({title:"Error",text:"CPF inválido",type:"error",hide:!0,buttons:{closer:!0,sticker:!0},icon:"fa fa-exclamation-circle"}),$(e.currentTarget).val(""),!1},_validateTel:function(e){var t=/^(\(11\) [9][0-9]{4}-[0-9]{4})|(\(1[2-9]\) [5-9][0-9]{3}-[0-9]{4})|(\([2-9][1-9]\) [5-9][0-9]{3}-[0-9]{4})$/;if($(e.currentTarget).val()===""||!t.test($(e.currentTarget).val()))return new PNotify({title:"Error",text:"Telefone inválido",type:"error",hide:!0,buttons:{closer:!0,sticker:!0},icon:"fa fa-exclamation-circle"}),$(e.currentTarget).val(""),!1},initialize:function(t){e.prototype.initialize.call(this,t)},_checkMesmoEndereco:function(e){e.currentTarget.checked?$(".group-entrega").hide():($(".group-entrega").show(),$("#cep_entrega").val(""),$("#end_entrega").val(""),$("#comp_entrega").val(""),$("#cidade_entrega").val(""),$("#estado_entrega").val(""))},_validateCEP:function(e){var t=$(e.currentTarget).val().replace(/[^0-9]/,""),n=$(e.currentTarget).data("info"),r=this.notification_wait();if(t.length!=8){r.remove();var i={title:"Error!",type:"error",text:"Cep "+n+" inválido",hide:!0,icon:"fa fa-exclamation-circle",buttons:{closer:!0,sticker:!0}};return $(e.currentTarget).val(""),$("body").removeClass("window-disable"),r.update(i),$("#end_"+n).val(""),$("#cidade_"+n).val(""),$("#estado_"+n).val(""),!1}var s="http://viacep.com.br/ws/"+t+"/json/",o=this;$.getJSON(s,function(t){if(t.logradouro==null){r.remove();var i={title:"Error!",type:"error",text:"Cep "+n+" não encontrado",hide:!0,buttons:{closer:!0,sticker:!0},icon:"fa fa-exclamation-circle"};return $("body").removeClass("window-disable"),r.update(i),$(e.currentTarget).val(""),$("#end_"+n).val(""),$("#cidade_"+n).val(""),$("#estado_"+n).val(""),!1}try{$("#end_"+n).val(t.logradouro+" "+t.bairro),$("#cidade_"+n).val(t.localidade),$("#estado_"+n).val(t.uf),o.notification_done(r)}catch(s){}})},_validateTask:function(){return!0},_goBack:function(e){e.preventDefault(),window.history.back()},initialize:function(t){e.prototype.initialize.call(this,t)},render:function(){e.prototype.render.call(this);var t=this;$(".actionbar ul.process").removeClass("hidden"),$(".navbar-custom .navbar-nav li.dashboard").removeClass("active"),$(".actionbar ul.dashboard").addClass("hidden"),this.$el.empty().append(this.template({})),$("input#data_compra").datetimepicker({format:"DD/MM/YYYY",locale:"pt-br"}),$("input.data").click(),$("input.price").priceFormat({prefix:"",thousandsSeparator:""}),$("input#data_compra").mask("00/00/0000"),$(".cep").mask("00000-000"),$(".phone").mask("(00) 0000-0000"),$(".cpf").mask("000.000.000-00",{reverse:!0}),$("#task").bind("change keyup",function(){$(this).validate({errorPlacement:function(e,t){return!0}}).checkForm()?$(".btn-submit").removeClass("disabled"):$(".btn-submit").addClass("disabled")})},_addInsumo:function(){var e=this;this.qteInsumos++,$(".insumos").append(this.insumoTemplate({insumo:this.qteInsumos})),$(".close-insumo").on("click",function(t){var n=$(t.currentTarget).data("id");$(".insumo-"+n).remove(),e.qteInsumos--}),$("input.price").priceFormat({prefix:"",thousandsSeparator:""})},close:function(){this.$el.empty().off()}});return i});